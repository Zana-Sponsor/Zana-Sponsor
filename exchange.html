<script>
    const firebaseConfig = { apiKey: "AIzaSyB056_g2Y3AJjtjG9715FgtXIhtjFcMPPU", authDomain: "zana-exchange.firebaseapp.com", databaseURL: "https://zana-exchange-default-rtdb.firebaseio.com", projectId: "zana-exchange" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(); const db = firebase.database();

    // ==========================================
    // --- ڕێکخستنی حمولە و نرخەکان لێرەیە ---
    // ==========================================
    let exchangeRates = {
        // بۆ کارتەکان: 0.80 واتە %20 حمولە، 0.85 واتە %15 حمولە
        korek_fastpay: 0.81, 
        korek_fib: 0.80, 
        korek_qicard: 0.805,
        
        asia_fastpay: 0.82, 
        asia_fib: 0.81, 
        asia_qicard: 0.815,
        
        // بۆ دۆلار (USDT): نرخی یەک دۆلار بە دینار دابنێ
        usdt_fastpay: 1450, 
        usdt_fib: 1440, 
        usdt_qicard: 1445,
        
        // حمولەی نێوان واڵێتەکان (وەک فاستپەی بۆ فایب): 0.98 واتە %2 حمولە
        default_fee: 0.98 
    };
    // ==========================================

    function signIn() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
    function logout() { auth.signOut().then(() => location.reload()); }

    auth.onAuthStateChanged(user => { 
        if (user) { 
            document.getElementById('loginSection').style.display='none'; 
            document.getElementById('mainApp').style.display='block'; 
            document.getElementById('userName').innerText = user.displayName; 
            document.getElementById('userImg').src = user.photoURL; 
            loadHistory(user.email); 
            listenToNews();
            listenToRates(); // هێشتا گوێ لە فایەربەیس دەگرێت، ئەگەر لەوێ شتێک بگۆڕیت ئەم نرخانەی سەرەوە دەگۆڕێن
            setTimeout(() => { document.getElementById('tgModal').style.display='flex'; }, 1000);
        } 
    });

    function listenToNews() {
        db.ref('announcement').on('value', snap => {
            const data = snap.val();
            if(data && data.show) {
                document.getElementById('newsText').innerText = data.text;
                document.getElementById('newsBanner').style.display = 'block';
            } else { document.getElementById('newsBanner').style.display = 'none'; }
        });
    }

    function listenToRates() {
        db.ref('rates').on('value', (snap) => {
            const data = snap.val();
            if (data) {
                // ئەگەر لە فایەربەیس داتا هەبوو، ئەوا نرخەکان نوێ دەبنەوە
                exchangeRates = { ...exchangeRates, ...data };
                calc();
            }
        });
    }

    const wallets = { "FastPay": "7510074008", "FIB": "7510074008", "QiCard": "2879264048", "Asiacell": "07758887488", "Korek": "07510074008", "USDT": "TTaNnxWNt2bjgSvpRY7NpvyCHUXDi6wjYc" };
    function formatNum(num) { return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
    function closeModal() { document.getElementById('tgModal').style.display='none'; }
    function updateWallet() { document.getElementById('myNum').innerText = wallets[document.getElementById('from').value]; calc(); }

    function calc() {
        const val = document.getElementById('amt').value;
        const amt = parseFloat(val) || 0;
        const from = document.getElementById('from').value;
        const to = document.getElementById('receiveVia').value;
        
        document.getElementById('formattedHint').innerText = formatNum(val) + (from === "USDT" ? " $" : " IQD");

        if (from === to) { 
            document.getElementById('totalDisplay').innerText = "هەمان واڵێت نابێت"; 
            document.getElementById('feeDisplay').innerText = "";
            return; 
        }

        let final = 0;

        if (from === "Korek") {
            if (to === "FastPay") final = amt * exchangeRates.korek_fastpay;
            else if (to === "FIB") final = amt * exchangeRates.korek_fib;
            else if (to === "QiCard") final = amt * exchangeRates.korek_qicard;
        } 
        else if (from === "Asiacell") {
            if (to === "FastPay") final = amt * exchangeRates.asia_fastpay;
            else if (to === "FIB") final = amt * exchangeRates.asia_fib;
            else if (to === "QiCard") final = amt * exchangeRates.asia_qicard;
        } 
        else if (from === "USDT") {
            if (to === "FastPay") final = amt * exchangeRates.usdt_fastpay;
            else if (to === "FIB") final = amt * exchangeRates.usdt_fib;
            else if (to === "QiCard") final = amt * exchangeRates.usdt_qicard;
        } 
        else {
            final = amt * exchangeRates.default_fee;
        }

        document.getElementById('totalDisplay').innerText = formatNum(Math.floor(final)) + " IQD";
        
        if (amt > 0) {
            let fee = (from === "USDT") ? 0 : (amt - final);
            document.getElementById('feeDisplay').innerText = fee > 0 ? "بڕی حمولە: " + formatNum(Math.floor(fee)) + " IQD" : "";
        } else {
            document.getElementById('feeDisplay').innerText = "";
        }
    }
    // پاشماوەی فەنکشنەکانی پرۆسێس و لۆد کردنی مێژوو وەک خۆیەتی...
</script>
