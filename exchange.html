<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>ZANA EXCHANGE | Home</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;500;800&display=swap');
        :root { --accent: #00d2ff; --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #ffffff; }
        
        body { font-family: 'Vazirmatn', sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow-x: hidden; }
        
        /* ğŸ”” Popup Alert Style */
        .welcome-alert { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--accent); color: #000; padding: 15px 30px; border-radius: 50px; font-weight: 800; z-index: 10000; box-shadow: 0 10px 30px rgba(0,210,255,0.5); display: none; animation: slideDown 0.5s ease; }
        @keyframes slideDown { from { top: -100px; } to { top: 20px; } }

        /* ğŸ–¼ï¸ Updated Center Style */
        .main-container { max-width: 500px; margin: 0 auto; padding: 20px; }
        .glass-card { background: linear-gradient(145deg, #1c2128, #111419); border: 1px solid var(--border); border-radius: 35px; padding: 25px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); margin-top: 20px; }
        
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-size: 13px; color: var(--accent); margin-right: 10px; }
        
        select, input { width: 100%; background: #0d1117; border: 1px solid var(--border); border-radius: 15px; padding: 15px; color: #fff; font-family: 'Vazirmatn'; outline: none; transition: 0.3s; }
        select:focus, input:focus { border-color: var(--accent); box-shadow: 0 0 10px rgba(0,210,255,0.2); }

        .exchange-info { background: rgba(255,255,255,0.03); border-radius: 20px; padding: 20px; text-align: center; border: 1px dashed var(--border); margin: 20px 0; }
        .btn-send { background: linear-gradient(90deg, #00d2ff, #3a7bd5); color: #fff; border: none; width: 100%; padding: 18px; border-radius: 20px; font-weight: 800; font-size: 18px; cursor: pointer; box-shadow: 0 10px 20px rgba(58,123,213,0.3); }

        /* ğŸ“‹ History Advanced Style */
        .history-item { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 15px; margin-bottom: 15px; }
        .h-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .h-label { color: #8b949e; }
        .h-val { font-weight: bold; }
    </style>
</head>
<body>

<div id="welcomeMsg" class="welcome-alert">Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØª Ø¨Û† ZANA EXCHANGE ğŸš€</div>

<div class="main-container">
    <div class="glass-card">
        <h2 style="text-align: center; margin-top: 0;">Ú¯Û†Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ø¯Ø±Ø§Ùˆ</h2>
        
        <div class="input-group">
            <label>Ù†Ø§Ø±Ø¯Ù† Ù„Û•:</label>
            <select id="from" onchange="updateUI()">
                <option value="FastPay">FastPay (2% Fee)</option>
                <option value="QiCard">Qi Card (2% Fee)</option>
                <option value="FIB">FIB Bank (2% Fee)</option>
                <option value="Asiacell">Asiacell (0.82 Rate)</option>
                <option value="Korek">Korek (0.80 Rate)</option>
            </select>
        </div>

        <div class="input-group">
            <label>Ø¨Ú•ÛŒ Ù¾Ø§Ø±Û•:</label>
            <input type="number" id="amt" placeholder="Ø¨Ú•Û•Ú©Û• Ø¨Ù†ÙˆÙˆØ³Û•..." oninput="calculate()">
        </div>

        <div class="input-group">
            <label>ÙˆÛ•Ø±Ú¯Ø±ØªÙ† Ù„Û•:</label>
            <select id="to" onchange="calculate()">
                <option value="FastPay">FastPay</option>
                <option value="FIB">FIB Bank</option>
                <option value="QiCard">Qi Card</option>
            </select>
        </div>

        <div class="exchange-info">
            <div id="res" style="font-size: 28px; font-weight: 800; color: var(--accent);">0 IQD</div>
            <div id="feeNote" style="font-size: 12px; opacity: 0.6; margin-top: 5px;">Ø­Û•Ù…ÙˆÙ„Û•: 0</div>
        </div>

        <input type="tel" id="userPhone" placeholder="Ú˜Ù…Ø§Ø±Û•ÛŒ ÙˆØ§ÚµÛØªÛŒ ØªÛ†" style="margin-bottom: 15px;">
        <input type="file" id="fileInput" accept="image/*" style="margin-bottom: 15px;">
        
        <button class="btn-send" onclick="submitOrder()">Ù†Ø§Ø±Ø¯Ù†ÛŒ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ <i class="fas fa-paper-plane"></i></button>
    </div>

    <h3 style="margin: 30px 10px 15px 0;"><i class="fas fa-history"></i> Ù…ÛÚ˜ÙˆÙˆÛŒ ÙˆØ±Ø¯ÛŒ Ù…Ø§Ù…Û•ÚµÛ•Ú©Ø§Ù†</h3>
    <div id="historyBox"></div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyB056_g2Y3AJjtjG9715FgtXIhtjFcMPPU", databaseURL: "https://zana-exchange-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(); const db = firebase.database();

    // ğŸ”” Show Welcome
    auth.onAuthStateChanged(user => {
        if(user) {
            const el = document.getElementById('welcomeMsg');
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 4000);
            loadHistory(user.email);
        }
    });

    function calculate() {
        const from = document.getElementById('from').value;
        const to = document.getElementById('to').value;
        const amt = parseFloat(document.getElementById('amt').value) || 0;
        let final = 0;
        let fee = 0;

        // ğŸ›‘ Rule: No same currency exchange
        if (from === to) {
            document.getElementById('res').innerText = "Ú¯Û†Ú•ÛŒÙ†ÛŒ Ù‡Ø§ÙˆØ´ÛÙˆÛ• Ù†Ø§Ø¨ÛØª";
            document.getElementById('res').style.color = "#ef4444";
            return;
        } else {
            document.getElementById('res').style.color = "var(--accent)";
        }

        if (from === "FastPay" || from === "QiCard" || from === "FIB") {
            fee = amt * 0.02;
            final = amt - fee;
        } else if (from === "Asiacell") {
            final = amt * 0.82;
            fee = amt - final;
        } else if (from === "Korek") {
            final = amt * 0.80;
            fee = amt - final;
        }

        document.getElementById('res').innerText = Math.floor(final).toLocaleString() + " IQD";
        document.getElementById('feeNote').innerText = "Ø­Û•Ù…ÙˆÙ„Û•: " + Math.floor(fee).toLocaleString() + " IQD";
    }

    async function submitOrder() {
        const from = document.getElementById('from').value;
        const to = document.getElementById('to').value;
        const amt = document.getElementById('amt').value;
        const phone = document.getElementById('userPhone').value;
        const file = document.getElementById('fileInput').files[0];

        if (from === to) return alert("Ù†Ø§ØªÙˆØ§Ù†ÛŒØª Ù‡Û•Ù…Ø§Ù† Ø¯Ø±Ø§Ùˆ Ø¨Ú¯Û†Ú•ÛŒØªÛ•ÙˆÛ•!");
        if (!amt || !phone || !file) return alert("ØªÚ©Ø§ÛŒÛ• Ù‡Û•Ù…ÙˆÙˆ Ø®Ø§Ù†Û•Ú©Ø§Ù† Ù¾Ú•Ø¨Ú©Û•Ø±Û•ÙˆÛ•");

        const id = "ZN-" + Math.floor(10000 + Math.random() * 90000);
        const data = {
            uEmail: auth.currentUser.email,
            uName: auth.currentUser.displayName,
            from: from,
            to: to,
            sentAmt: amt + " IQD",
            receiveAmt: document.getElementById('res').innerText,
            userPhone: phone,
            status: "Ú†Ø§ÙˆÛ•Ú•ÙˆØ§Ù†Û•",
            time: new Date().toLocaleString('ku-IQ')
        };

        await db.ref('orders/' + id).set(data);
        
        // Telegram Notification
        const fd = new FormData();
        fd.append("chat_id", "6259019006");
        fd.append("photo", file);
        fd.append("caption", `âš¡ï¸ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ Ù†ÙˆÛ: ${id}\nğŸ‘¤ Ù†Ø§Ùˆ: ${data.uName}\nğŸ“¥ Ù„Û•: ${from}\nğŸ“¤ Ø¨Û†: ${to}\nğŸ’° Ø¨Ú•ÛŒ ÙˆÛ•Ø±Ú¯Ø±ØªÙ†: ${data.receiveAmt}\nğŸ“± Ú˜Ù…Ø§Ø±Û•: ${phone}`);
        fetch(`https://api.telegram.org/bot8570457708:AAG_5hFu-octgBn1ruDJ3_OzEG7p4fWiNgo/sendPhoto`, { method: "POST", body: fd });

        alert("Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒÛŒÛ•Ú©Û•Øª Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ù†ÛØ±Ø¯Ø±Ø§ âœ…");
        location.reload();
    }

    function loadHistory(email) {
        db.ref('orders').orderByChild('uEmail').equalTo(email).on('value', snap => {
            let h = "";
            snap.forEach(c => {
                const o = c.val();
                const stClr = o.status === "Ú†Ø§ÙˆÛ•Ú•ÙˆØ§Ù†Û•" ? "#f1c40f" : (o.status.includes("âœ…") ? "#10b981" : "#ef4444");
                h = `
                <div class="history-item">
                    <div class="h-row" style="border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-bottom: 10px;">
                        <span style="color:var(--accent); font-weight:800;">ID: ${c.key}</span>
                        <span style="color:${stClr}">${o.status}</span>
                    </div>
                    <div class="h-row"><span class="h-label">Ù†Ø§Ø±Ø¯Ù† Ù„Û•:</span><span class="h-val">${o.from}</span></div>
                    <div class="h-row"><span class="h-label">ÙˆÛ•Ø±Ú¯Ø±ØªÙ† Ù„Û•:</span><span class="h-val">${o.to}</span></div>
                    <div class="h-row"><span class="h-label">Ø¨Ú•ÛŒ Ù†ÛØ±Ø¯Ø±Ø§Ùˆ:</span><span class="h-val">${o.sentAmt}</span></div>
                    <div class="h-row"><span class="h-label">Ø¨Ú•ÛŒ ÙˆÛ•Ø±Ú¯Ø±ØªÙ†:</span><span class="h-val" style="color:#10b981">${o.receiveAmt}</span></div>
                    <div class="h-row"><span class="h-label">Ú˜Ù…Ø§Ø±Û•ÛŒ Ù…Û†Ø¨Ø§ÛŒÙ„:</span><span class="h-val">${o.userPhone}</span></div>
                    <div class="h-row" style="border:none;"><span class="h-label">Ø¨Û•Ø±ÙˆØ§Ø±:</span><span class="h-val" style="font-size:10px;">${o.time}</span></div>
                </div>` + h;
            });
            document.getElementById('historyBox').innerHTML = h || "<p style='text-align:center; opacity:0.3;'>Ù‡ÛŒÚ† Ù…Ø§Ù…Û•ÚµÛ•ÛŒÛ•Ú© Ù†ÛŒÛŒÛ•</p>";
        });
    }
</script>
</body>
</html>
