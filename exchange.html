<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zana Exchange | Optimized</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --main: #facc15; --bg: #0f172a; --card: #1e293b; --success: #10b981; --danger: #ef4444; --gold: linear-gradient(135deg, #facc15 0%, #eab308 100%); }
        body { font-family: 'Tahoma', sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; text-align: right; }
        .container { max-width: 400px; margin: auto; display: none; }
        
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(15px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .google-card { background: var(--card); padding: 35px; border-radius: 30px; border: 1px solid rgba(250, 204, 21, 0.2); text-align: center; width: 85%; }
        .google-btn { background: white; color: #1e293b; border: none; padding: 15px; border-radius: 15px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; margin-top: 20px; }

        .user-bar { display: flex; align-items: center; justify-content: space-between; background: var(--card); padding: 12px 15px; border-radius: 20px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .profile-img { width: 42px; height: 42px; border-radius: 50%; border: 2px solid var(--main); }

        .card { background: var(--card); padding: 20px; border-radius: 25px; border: 1px solid #334155; margin-bottom: 20px; }
        .wallet { background: rgba(15, 23, 42, 0.8); padding: 12px; border-radius: 18px; text-align: center; border: 1px solid var(--main); margin-bottom: 15px; }
        .group { margin-bottom: 15px; }
        label { display: block; font-size: 11px; color: #94a3b8; margin-bottom: 5px; }
        select, input { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; text-align: right; font-size: 14px; }
        
        .result-box { background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); margin-top: 10px; }
        .btn { background: var(--gold); color: #000; border: none; width: 100%; padding: 15px; border-radius: 14px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .hist-item { background: var(--card); padding: 15px; border-radius: 20px; margin-bottom: 12px; border-right: 5px solid var(--main); }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="google-card">
        <h2 style="color:white;">ZANA EXCHANGE</h2>
        <button class="google-btn" onclick="signIn()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> چوونەژوورەوە بە Google
        </button>
    </div>
</div>

<div class="container" id="mainApp">
    <div class="user-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <img id="userImg" src="" class="profile-img">
            <span id="userName" style="font-size: 13px; font-weight: bold;">...</span>
        </div>
        <i class="fas fa-sign-out-alt" style="color:var(--danger); cursor:pointer;" onclick="auth.signOut()"></i>
    </div>

    <div class="card">
        <div class="wallet">
            <span style="font-size: 10px; color: var(--main);">بۆ ئەم ژمارەیە بنێرە:</span>
            <div style="direction:ltr; font-weight:bold;" id="targetNum">07510074008</div>
        </div>

        <div class="group">
            <label>لە کوێوە دەینێریت؟ (From)</label>
            <select id="from" onchange="calc()">
                <option value="fastpay">FastPay (فاستپەی)</option>
                <option value="usdt">USDT</option>
                <option value="korek">Korek (کۆڕەک)</option>
                <option value="fib">FIB (ئێف ئای بی)</option>
                <option value="qi">Qi Card (کي کارد)</option>
            </select>
        </div>

        <div class="group">
            <label>بۆ چ دراوێک؟ (To)</label>
            <select id="to" onchange="calc()">
                <option value="fib">FIB (ئێف ئای بی)</option>
                <option value="fastpay">FastPay (فاستپەی)</option>
                <option value="qi">Qi Card (کي کارد)</option>
            </select>
        </div>

        <div class="group">
            <label>بڕی پارە</label>
            <input type="number" id="amt" oninput="calc()" placeholder="بڕی پارە لێرە بنووسە...">
        </div>

        <div class="group">
            <label>ژمارەی مۆبایلی وەرگر (تەنها ژمارە)</label>
            <input type="text" id="userPh" oninput="validatePhone(this)" placeholder="07XXXXXXXXX">
        </div>

        <div class="result-box">
            <div style="display:flex; justify-content:space-between; font-size:13px;">
                <span>بڕی گەیشتوو:</span>
                <b id="totalResult" style="color:var(--main)">0 IQD</b>
            </div>
            <div id="rateNote" style="font-size:10px; color:#94a3b8; margin-top:5px;"></div>
        </div>

        <button class="btn" onclick="processOrder()">ناردنی داواکاری</button>
    </div>

    <div id="historyList"></div>
</div>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyB056_g2Y3AJjtjG9715FgtXIhtjFcMPPU", 
        authDomain: "zana-exchange.firebaseapp.com", 
        databaseURL: "https://zana-exchange-default-rtdb.firebaseio.com", 
        projectId: "zana-exchange" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    function signIn() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }

    auth.onAuthStateChanged(user => {
        document.getElementById('loginOverlay').style.display = user ? 'none' : 'flex';
        document.getElementById('mainApp').style.display = user ? 'block' : 'none';
        if(user) {
            document.getElementById('userName').innerText = user.displayName;
            document.getElementById('userImg').src = user.photoURL;
        }
    });

    // ڕێگری لە نووسینی پیت و قبوڵکردنی تەنها ژمارە
    function validatePhone(input) {
        input.value = input.value.replace(/[^0-9]/g, '');
    }

    function calc() {
        const from = document.getElementById('from').value;
        const amt = parseFloat(document.getElementById('amt').value) || 0;
        let total = 0;
        let note = "";

        if (from === 'korek') {
            // 100 هەزار کۆڕەک = 82 هەزار (واتە لێدانی 0.82)
            total = amt * 0.82;
            note = "نرخی گۆڕینەوە: هەر 100,000 کۆڕەک بە 82,000 دینارە";
        } 
        else if (from === 'usdt') {
            // 100$ USDT = 145 هەزار
            total = amt * 1450; 
            note = "نرخی گۆڕینەوە: 1$ USDT بە 1,450 دینارە";
        }
        else {
            // بۆ دراوەکانی تر وەک فاستپەی و FIB و Qi (1% حەماڵە)
            total = amt * 0.99;
            note = "حەماڵە: 1% لە بڕی نێردراو دادەشکێندرێت";
        }

        document.getElementById('totalResult').innerText = total.toLocaleString() + " IQD";
        document.getElementById('rateNote').innerText = note;
    }

    async function processOrder() {
        const u = auth.currentUser;
        const amt = document.getElementById('amt').value;
        const ph = document.getElementById('userPh').value;

        if(!amt || !ph) return alert("تکایە بڕی پارە و ژمارەی مۆبایل پڕبکەرەوە");
        if(ph.length < 10) return alert("تکایە ژمارەیەکی دروست بنووسە");

        const id = Math.floor(10000 + Math.random() * 90000);
        await db.ref('orders/' + id).set({
            orderID: id,
            uName: u.displayName,
            uEmail: u.email,
            from: document.getElementById('from').value,
            to: document.getElementById('to').value,
            amt: amt,
            receive: document.getElementById('totalResult').innerText,
            phone: ph,
            status: 'pending',
            time: new Date().toLocaleString('ku-IQ')
        });
        alert("داواکارییەکەت بەسەرکەوتوویی نێردرا!");
        document.getElementById('amt').value = "";
    }
</script>
</body>
</html>
