<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ZANA ADMIN | ÙˆÛ•ÚµØ§Ù…Ø¯Ø§Ù†Û•ÙˆÛ•ÛŒ Ú†Ø§Øª Ùˆ Ø¨Û•Ú•ÛÙˆÛ•Ø¨Ø±Ø¯Ù†</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        :root { --primary: #00d2ff; --bg: #0a0a0c; --card: #16161a; --border: #2d2d35; --text: #ffffff; }
        
        body { font-family: 'Vazirmatn', Tahoma; background: var(--bg); color: var(--text); margin: 0; padding: 20px; direction: rtl; }
        .grid-container { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        .box { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--border); margin-bottom: 20px; }
        
        /* ğŸ’¬ Admin Chat Style */
        .chat-list-item { padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .chat-list-item:hover { background: #1f1f24; }
        .chat-active { border-right: 4px solid var(--primary); background: #1f1f24; }
        
        .chat-view { height: 400px; display: flex; flex-direction: column; background: #0d1117; border-radius: 12px; overflow: hidden; }
        #adminChatBody { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .admin-msg { padding: 8px 12px; border-radius: 10px; max-width: 80%; font-size: 13px; }
        .admin-msg.from-user { align-self: flex-start; background: #21262d; }
        .admin-msg.from-admin { align-self: flex-end; background: var(--primary); color: #000; }

        .btn-send { background: var(--primary); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        input { width: 100%; padding: 12px; background: #1f1f24; border: 1px solid var(--border); color: white; border-radius: 8px; box-sizing: border-box; }
    </style>
</head>
<body>

    <h2 style="margin-bottom: 20px;"><i class="fas fa-user-shield"></i> Ø¨Û•Ú•ÛÙˆÛ•Ø¨Ø±Ø¯Ù†ÛŒ Ø²Ø§Ù†Ø§</h2>

    <div class="grid-container">
        
        <div>
            <div class="box">
                <h3 id="chatTitle">ğŸ’¬ Ú†Ø§ØªÛŒ Ú©Ú•ÛŒØ§Ø±Û•Ú©Ø§Ù†</h3>
                <div class="grid-container" style="grid-template-columns: 250px 1fr; height: 450px;">
                    <div id="userChatList" style="border-left: 1px solid var(--border); overflow-y: auto;">
                        </div>
                    <div class="chat-view">
                        <div id="adminChatBody">ØªÚ©Ø§ÛŒÛ• Ú©Ú•ÛŒØ§Ø±ÛÚ© Ù‡Û•ÚµØ¨Ú˜ÛØ±Û• Ø¨Û† Ø¯Û•Ø³ØªÙ¾ÛÚ©Ø±Ø¯Ù†ÛŒ Ú†Ø§Øª</div>
                        <div style="padding: 10px; display: flex; gap: 5px; background: var(--card);">
                            <input type="text" id="adminChatInput" placeholder="ÙˆÛ•ÚµØ§Ù… Ø¨Ù†ÙˆÙˆØ³Û•...">
                            <button class="btn-send" onclick="adminSendMsg()"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="box">
                <h3>ğŸ“¥ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒÛŒÛ• Ù†ÙˆÛÛŒÛ•Ú©Ø§Ù†</h3>
                <div id="ordersList"></div>
            </div>
        </div>

        <div>
            <div class="box">
                <h3>ğŸ‘¥ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±Ø§Ù†</h3>
                <div id="usersList" style="max-height: 500px; overflow-y: auto;"></div>
            </div>
            
            <div class="box">
                <h3>âš™ï¸ Ú•ÛÚ©Ø®Ø³ØªÙ†ÛŒ Ø¦Û•Ù¾</h3>
                <button onclick="setLock(true)" style="background:red; color:white; width:100%; padding:10px; margin-bottom:5px; border-radius:8px; border:none;">Lock App</button>
                <button onclick="setLock(false)" style="background:green; color:white; width:100%; padding:10px; border-radius:8px; border:none;">Unlock App</button>
            </div>
        </div>

    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyB056_g2Y3AJjtjG9715FgtXIhtjFcMPPU", databaseURL: "https://zana-exchange-default-rtdb.firebaseio.com" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentSelectedUser = null;

        // --- 1. Ù„ÛŒØ³ØªÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±Ø§Ù† Ø¨Û† Ú†Ø§Øª ---
        db.ref('chats').on('value', snap => {
            let html = "";
            snap.forEach(userChat => {
                const uid = userChat.key;
                const msgs = Object.values(userChat.val());
                const lastMsg = msgs[msgs.length - 1];
                html += `
                <div class="chat-list-item ${currentSelectedUser === uid ? 'chat-active' : ''}" onclick="selectUserChat('${uid}', '${lastMsg.name}')">
                    <div style="flex:1">
                        <div style="font-size:13px; font-weight:bold;">${lastMsg.name}</div>
                        <div style="font-size:11px; opacity:0.6; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:180px;">${lastMsg.text}</div>
                    </div>
                </div>`;
            });
            document.getElementById('userChatList').innerHTML = html;
        });

        // --- 2. Ù‡Û•ÚµØ¨Ú˜Ø§Ø±Ø¯Ù†ÛŒ Ú©Ú•ÛŒØ§Ø± Ø¨Û† Ú†Ø§Øª ---
        function selectUserChat(uid, name) {
            currentSelectedUser = uid;
            document.getElementById('chatTitle').innerText = "ğŸ’¬ Ú†Ø§Øª Ù„Û•Ú¯Û•Úµ: " + name;
            loadAdminMsgs(uid);
        }

        function loadAdminMsgs(uid) {
            db.ref('chats/' + uid).on('value', snap => {
                let html = "";
                snap.forEach(c => {
                    const m = c.val();
                    const type = m.sender === "admin" ? 'from-admin' : 'from-user';
                    html += `<div class="admin-msg ${type}">${m.text}</div>`;
                });
                const body = document.getElementById('adminChatBody');
                body.innerHTML = html;
                body.scrollTop = body.scrollHeight;
            });
        }

        // --- 3. Ù†Ø§Ø±Ø¯Ù†ÛŒ Ù†Ø§Ù…Û• Ù„Û•Ù„Ø§ÛŒÛ•Ù† Ø¦Ø§Ø¯Ù…ÛŒÙ† ---
        function adminSendMsg() {
            const txt = document.getElementById('adminChatInput').value;
            if(!txt || !currentSelectedUser) return;
            db.ref('chats/' + currentSelectedUser).push({
                sender: "admin",
                name: "Admin",
                text: txt,
                time: Date.now()
            });
            document.getElementById('adminChatInput').value = '';
        }

        // --- 4. Ù„ÛŒØ³ØªÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±Ø§Ù†ÛŒ Ú¯Ø´ØªÛŒ (Ø¨Û† Ø¨Ù„Û†Ú©Ú©Ø±Ø¯Ù†) ---
        db.ref('users').on('value', snap => {
            let html = "";
            snap.forEach(c => {
                const u = c.val();
                html += `
                <div style="display:flex; align-items:center; justify-content:space-between; padding:10px; border-bottom:1px solid #222;">
                    <div style="font-size:12px;">${u.name}<br><small style="color:#666">${u.email}</small></div>
                    <button onclick="toggleBlock('${c.key}', ${u.isBlocked || false})" style="background:${u.isBlocked ? 'green' : 'red'}; color:white; border:none; padding:5px; border-radius:5px; font-size:10px;">
                        ${u.isBlocked ? 'Unblock' : 'Block'}
                    </button>
                </div>`;
            });
            document.getElementById('usersList').innerHTML = html;
        });

        function toggleBlock(uid, st) { db.ref('users/' + uid).update({ isBlocked: !st }); }
        function setLock(st) { db.ref('appStatus').set({ locked: st, message: "Ø¦Û•Ù¾Û•Ú©Û• Ø¨Û• Ø´ÛÙˆÛ•ÛŒÛ•Ú©ÛŒ Ú©Ø§ØªÛŒ Ú•Ø§Ú¯ÛŒØ±Ø§ÙˆÛ•" }); }

        // --- 5. Ù„ÛŒØ³ØªÛŒ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒÛŒÛ•Ú©Ø§Ù† ---
        db.ref('orders').on('value', snap => {
            let html = "";
            snap.forEach(c => {
                const o = c.val();
                html += `
                <div class="box" style="background:#1a1a1e; border-color:#333;">
                    <b>ID: ${c.key} - ${o.uName}</b><br>
                    <small>${o.from} â” ${o.to} | Ø¨Ú•: ${o.total}</small><br>
                    <button onclick="updateOrder('${c.key}', 'ÙˆÛ•Ø±Ú¯ÛŒØ±Ø§')" style="background:green; color:white; border:none; padding:5px 10px; border-radius:5px; margin-top:10px;">Ù‚Ø¨ÙˆÚµÚ©Ø±Ø¯Ù†</button>
                    <button onclick="updateOrder('${c.key}', 'Ú•Û•ØªÚ©Ø±Ø§ÛŒÛ•ÙˆÛ•')" style="background:red; color:white; border:none; padding:5px 10px; border-radius:5px; margin-top:10px;">Ú•Û•ØªÚ©Ø±Ø¯Ù†Û•ÙˆÛ•</button>
                </div>`;
            });
            document.getElementById('ordersList').innerHTML = html;
        });

        function updateOrder(id, s) { db.ref('orders/' + id).update({ status: s }); }

    </script>
</body>
</html>
